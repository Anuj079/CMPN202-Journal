<!DOCTYPE html>
<html class="antialiased dark:bg-neutral-950">
  <head>
    <title>Journal Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      @font-face {
        font-family: "Mechanized";
        src: url("/font/Mechanized-Regular.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }
      
      ::-webkit-scrollbar {
        display: none;
      }
    </style>
    <script>
      tailwind.config = {
        darkMode: "media",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              heading: ["Mechanized", "serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            typography: (theme) => ({
              DEFAULT: {
                css: {
                  maxWidth: "none",
                  fontFamily: '"Inter", sans-serif',
                  h1: { fontFamily: '"Mechanized", serif', fontWeight: "700" },
                  h2: { fontFamily: '"Mechanized", serif', fontWeight: "700" },
                  h3: { fontFamily: '"Mechanized", serif', fontWeight: "700" },
                  h4: { fontFamily: '"Mechanized", serif', fontWeight: "700" },
                  pre: {
                    backgroundColor: "#191919",
                    color: "#fff",
                    borderRadius: "1rem !important",
                    fontFamily: '"JetBrains Mono", monospace',
                    fontSize: "0.8em !important",
                    lineHeight: "1.2 !important",
                    margin: "0 !important",
                  },
                  "code::before": { content: '""' },
                  "code::after": { content: '""' },
                  table: {
                    tableLayout: "auto",
                    borderCollapse: "separate",
                    borderSpacing: 0,
                    background: "#191919",
                    borderRadius: ".5em",
                    border: "1px solid #6663",
                    width: "100%",
                    marginTop: "2em",
                    marginBottom: "2em",
                    fontSize: ".8em !important",
                    lineHeight: "1.71429",
                    overflow: "hidden",
                    color: "#fff",
                  },
                  th: {
                    textAlign: "start",
                    padding: "calc(.25rem * 2.5) !important",
                    borderInlineStart: "1px solid #6663",
                    background: "#212121",
                    borderBottomWidth: "1px",
                    borderBottomColor: "#6663",
                    color: "#fff",
                  },
                  td: {
                    color: "#c2c2c2",
                    textAlign: "start",
                    borderInlineStart: "1px solid #6663",
                    padding: "calc(.25rem * 2.5) !important",
                    borderBottom: "1px solid #6663",
                    strong: {
                      color: "#fff",
                    },
                    code: {
                      color: "#fff",
                    }
                  },

                },
              },
            }),
          },
        },
      };
    </script>
  </head>
  <body
    class="bg-white dark:bg-neutral-950 min-h-screen text-neutral-900 dark:text-neutral-100 font-sans"
  >
    <div class="max-w-4xl mx-auto px-6 py-12">
      <a
        href="index.html"
        class="group inline-flex items-center text-sm font-semibold text-neutral-500 hover:text-sky-500 transition-colors mb-12"
      >
        <div
          class="mr-2 p-1 rounded-full bg-neutral-100 dark:bg-neutral-800 group-hover:bg-sky-500/10 transition-colors"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            ></path>
          </svg>
        </div>
        Back to Dashboard
      </a>

      <div id="nav-top" class="flex justify-between items-center mb-12 text-sm font-medium text-neutral-400 tracking-wide">
          </div>

      <header
        id="journal-header"
        class="mb-10 pb-10 border-b border-neutral-100 dark:border-neutral-800"
      >
        <div
          class="animate-pulse h-10 bg-neutral-200 dark:bg-neutral-800 rounded w-1/2 mb-4"
        ></div>
        <div
          class="animate-pulse h-4 bg-neutral-200 dark:bg-neutral-800 rounded w-1/3"
        ></div>
      </header>

      <article
        id="content"
        class="prose prose-lg text-justify dark:prose-invert prose-headings:font-bold prose-a:text-sky-500 prose-img:rounded-xl prose-img:shadow-lg"
      >
        <div class="animate-pulse space-y-6">
          <div class="h-4 bg-neutral-200 dark:bg-neutral-800 rounded"></div>
          <div class="h-4 bg-neutral-200 dark:bg-neutral-800 rounded"></div>
          <div
            class="h-4 bg-neutral-200 dark:bg-neutral-800 rounded w-5/6"
          ></div>
        </div>
      </article>

      <div id="nav-bottom" class="flex justify-between items-center mt-20 pt-10 border-t border-neutral-800 text-sm font-medium text-neutral-400 tracking-wide">
          </div>

    </div>

    <div
      id="lightbox"
      class="fixed inset-0 z-[100] bg-black/95 opacity-0 pointer-events-none transition-opacity duration-300 flex items-center justify-center p-2 backdrop-blur-sm"
      onclick="closeLightbox()"
    >
      <img
        id="lightbox-img"
        src=""
        class="max-w-[95vw] max-h-[95vh] w-full h-full rounded-lg shadow-2xl object-contain transform transition-transform duration-300 ease-out cursor-zoom-out"
        alt="Full screen view"
      />
    </div>

    <script>
      function generateId() {
        return Math.random().toString(36).substr(2, 9);
      }

      function toggleCode(id) {
        const wrapper = document.getElementById(`wrapper-${id}`);
        const gradient = document.getElementById(`gradient-${id}`);
        const headerBtnText = document.getElementById(`header-btn-text-${id}`);
        const headerIcon = document.getElementById(`header-icon-${id}`);
        
        const isExpanded = wrapper.style.maxHeight !== '500px';

        if (isExpanded) {
            wrapper.style.maxHeight = '500px';
            gradient.style.display = 'flex';
            headerBtnText.innerText = "Expand";
            headerIcon.style.transform = "rotate(0deg)";
        } else {
            wrapper.style.maxHeight = wrapper.scrollHeight + "px";
            gradient.style.display = 'none';
            headerBtnText.innerText = "Collapse";
            headerIcon.style.transform = "rotate(180deg)";
        }
      }

      function openLightbox(src, alt) {
        const lightbox = document.getElementById("lightbox");
        const img = document.getElementById("lightbox-img");
        img.src = src;
        img.alt = alt || "";

        document.body.style.overflow = "hidden";
        lightbox.classList.remove("opacity-0", "pointer-events-none");
        lightbox.classList.add("opacity-100", "pointer-events-auto");
      }

      function closeLightbox() {
        const lightbox = document.getElementById("lightbox");
        const img = document.getElementById("lightbox-img");
        lightbox.classList.remove("opacity-100", "pointer-events-auto");
        lightbox.classList.add("opacity-0", "pointer-events-none");
        document.body.style.overflow = "auto";
        setTimeout(() => {
          img.src = "";
        }, 300);
      }

      function splitContent(text) {
        const match = text.match(
          /^---\s*[\r\n]+([\s\S]*?)[\r\n]+---\s*[\r\n]+([\s\S]*)$/
        );

        if (match) {
          const yaml = match[1];
          const content = match[2];
          const metadata = {};

          yaml.split("\n").forEach((line) => {
            const parts = line.split(":");
            if (parts.length >= 2) {
              const key = parts[0].trim();
              const val = parts.slice(1).join(":").trim();
              metadata[key] = val;
            }
          });

          return { metadata, content };
        }

        return { metadata: {}, content: text };
      }

      const renderer = new marked.Renderer();
      renderer.image = function ({ href, title, text }) {
        const caption = text
          ? `<figcaption class="mt-3 text-center text-sm text-neutral-500 dark:text-neutral-400 font-medium">${text}</figcaption>`
          : "";
        const safeHref = encodeURI(href);
        const safeText = text ? text.replace(/'/g, "\\'") : "";
        return `
          <figure class="flex flex-col items-center my-8">
              <img 
              src="${safeHref}" 
              alt="${text}" 
              title="${title || ""}" 
              onclick="openLightbox('${safeHref}', '${safeText}')"
              class="rounded-xl cursor-zoom-in shadow-2xl border border-neutral-100 dark:border-neutral-800 max-h-[600px] w-auto object-contain bg-neutral-50 dark:bg-neutral-900/50">
              ${caption}
          </figure>
                `;
      };

      renderer.code = function (code, infostring, escaped) {
        const lang = code.lang;
        const id = generateId();

        const terminalIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-terminal-icon lucide-square-terminal"><path d="m7 11 2-2-2-2"/><path d="M11 13h4"/><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>`;
        const expandIcon = `<svg id="header-icon-${id}" class="w-4 h-4 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`;
        return `
    <div class="not-prose my-6 border border-[#ffffff1c] rounded-lg relative">
      <div class="flex items-center justify-between rounded-t-lg py-2 px-4 text-xs font-semibold bg-neutral-900 border-b border-[#ffffff1c] text-neutral-300 select-none" style="font-family: 'JetBrains Mono', monospace;">
        <div class="flex items-center text-xs font-semibold text-neutral-300 font-mono">
                    ${terminalIcon}
                    ${lang}
                </div>
        <button id="header-btn-${id}" onclick="toggleCode('${id}')" class="flex items-center gap-2 text-xs text-neutral-500 hover:text-white transition-colors overflow-trigger hidden">
                    <span id="header-btn-text-${id}">Expand</span>
                    ${expandIcon}
                </button>
      </div>
      <pre class="rounded-b-lg text-sm overflow-x-auto"><code id="wrapper-${id}" class="hljs p-4! language-${lang}" style="padding: 0.75rem; background-color: #191919; max-height: none;">${code.text}</code></pre>
      <div id="gradient-${id}" class="absolute inset-x-0 bottom-0 flex h-24 items-center justify-center rounded-b-lg bg-gradient-to-b from-transparent to-[#09090b] pb-4 hidden">
                 <button onclick="toggleCode('${id}')" class="bg-neutral-800 hover:bg-neutral-700 text-neutral-300 text-xs font-medium px-4 py-1.5 rounded-full shadow-lg border border-neutral-700 transition-all hover:scale-105 flex items-center gap-2">
                    Expand
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" /></svg>
                 </button>
            </div>
    </div>
    <img src="" onerror="checkHeight('${id}')" style="display:none;" />
  `;
      };

      marked.use({ renderer: renderer });
      marked.setOptions({
        highlight: function (code, lang) {
          const language = highlight.getLanguage(lang) ? lang : "plaintext";
          return highlight.highlight(code, { language }).value;
        }
      });

      window.checkHeight = function(id) {
        const wrapper = document.getElementById(`wrapper-${id}`);
        const gradient = document.getElementById(`gradient-${id}`);
        const headerBtn = document.getElementById(`header-btn-${id}`);        

        if (wrapper.scrollHeight > 500) {
            wrapper.style.maxHeight = '500px';
            gradient.classList.remove('hidden');
            headerBtn.classList.remove('hidden');
        } else {
            wrapper.style.maxHeight = 'none';
        }
      }

      function setupNavigation(currentPage) {
        const match = currentPage.match(/week(\d+)/i);
        if (!match) return;

        const currentNum = parseInt(match[1]);
        const maxWeeks = 7;

        let prevHtml = `<div></div>`;
        let nextHtml = `<div></div>`;

        if (currentNum > 1) {
            prevHtml = `
                <a href="view.html?page=week${currentNum - 1}" class="group flex items-center hover:text-white transition-colors">
                    <svg class="w-4 h-4 mr-2 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <span>Week ${currentNum - 1}</span>
                </a>`;
        }

        if (currentNum < maxWeeks) {
            nextHtml = `
                <a href="view.html?page=week${currentNum + 1}" class="group flex items-center hover:text-white transition-colors text-right">
                    <span>Week ${currentNum + 1}</span>
                    <svg class="w-4 h-4 ml-2 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </a>`;
        }
        const navHtml = `${prevHtml}${nextHtml}`;
        document.getElementById("nav-top").innerHTML = navHtml;
        document.getElementById("nav-bottom").innerHTML = navHtml;
      }

      const params = new URLSearchParams(window.location.search);
      const page = params.get("page");

      if (page) {
        setupNavigation(page);
        const fetchPath = `journal/${page}.md`;

        fetch(fetchPath)
          .then((response) => {
            if (!response.ok) throw new Error("File not found");
            return response.text();
          })
          .then((fullText) => {
            const { metadata, content } = splitContent(fullText);

            const headerHTML = `
                        <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight text-neutral-900 dark:text-white mb-6 font-heading">
                            ${metadata.title || "Untitled Entry"}
                        </h1>
                        
                        <p class="text-lg md:text-xl text-neutral-500 dark:text-neutral-400 leading-relaxed mb-6">
                            ${metadata.description || ""}
                        </p>

                        <div class="flex items-center text-sm font-medium text-sky-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="uppercase tracking-wider">${
                              metadata.date || "Date TBD"
                            }</span>
                            <span class="mx-3 text-neutral-300 dark:text-neutral-700">â€¢</span>
                            <span class="text-neutral-400 dark:text-neutral-500">Author: ${
                              metadata.author || "Student"
                            }</span>
                        </div>
                        `;
            document.getElementById("journal-header").innerHTML = headerHTML;

            document.getElementById("content").innerHTML =
              marked.parse(content);
          })
          .catch((error) => {
            document.getElementById("journal-header").style.display = "none";
            document.getElementById("content").innerHTML = `
                            <div class="text-center py-20">
                                <h1 class="text-4xl font-bold text-neutral-200 dark:text-neutral-800 mb-4">404</h1>
                                <p class="text-neutral-500">Could not load <code>${fetchPath}</code>.</p>
                            </div>`;
          });
      } else {
        document.getElementById("journal-header").style.display = "none";
        document.getElementById("content").innerHTML =
          "<h1 class='text-center mt-20 text-neutral-400'>No entry selected</h1>";
      }
    </script>
  </body>
</html>
